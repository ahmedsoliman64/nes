'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a};(function(a,b){'object'===('undefined'==typeof exports?'undefined':_typeof(exports))&&'object'===('undefined'==typeof module?'undefined':_typeof(module))?module.exports=b():'function'==typeof define&&define.amd?define(b):'object'===('undefined'==typeof exports?'undefined':_typeof(exports))?exports.nes=b():a.nes=b()})('undefined'==typeof window?global:window,function(){var a=function(){},b=1,c=function(a){try{return JSON.stringify(a)}catch(a){throw new f(a,e.USER)}},d=function(a){return function(b){setTimeout(function(){return a(b)},0)}},e={TIMEOUT:'timeout',DISCONNECT:'disconnect',SERVER:'server',PROTOCOL:'protocol',WS:'ws',USER:'user'},f=function(a,b){'string'==typeof a&&(a=new Error(a)),a.type=b,a.isNes=!0;try{throw a}catch(a){return a}},g={1000:'Normal closure',1001:'Going away',1002:'Protocol error',1003:'Unsupported data',1004:'Reserved',1005:'No status received',1006:'Abnormal closure',1007:'Invalid frame payload data',1008:'Policy violation',1009:'Message too big',1010:'Mandatory extension',1011:'Internal server error',1015:'TLS handshake'},h=function(b,c){c=c||{},this._url=b,this._settings=c,this._heartbeatTimeout=!1,this._ws=null,this._reconnection=null,this._reconnectionTimer=null,this._ids=0,this._requests={},this._subscriptions={},this._heartbeat=null,this._packets=[],this._disconnectListeners=null,this._disconnectRequested=!1,this.onError=function(a){return console.error(a)},this.onConnect=a,this.onDisconnect=a,this.onHeartbeatTimeout=a,this.onUpdate=a,this.id=null};return h.WebSocket='undefined'==typeof WebSocket?null:WebSocket,h.prototype.connect=function(a){var b=this;return(a=a||{},this._reconnection)?Promise.reject(new f('Cannot connect while client attempts to reconnect',e.USER)):this._ws?Promise.reject(new f('Already connected',e.USER)):(this._reconnection=!1===a.reconnect?null:{wait:0,delay:a.delay||1e3,maxDelay:a.maxDelay||5e3,retries:a.retries||Infinity,settings:{auth:a.auth,timeout:a.timeout}},new Promise(function(c,d){b._connect(a,!0,function(a){return a?d(a):c()})}))},h.prototype._connect=function(a,b,c){var i=this,j=new h.WebSocket(this._url,this._settings.ws);this._ws=j,clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null;var k=function(a){j.onopen&&l(new f('Connection terminated while waiting to connect',e.WS));var b=i._disconnectRequested;i._cleanup();var c={code:a.code,explanation:g[a.code]||'Unknown',reason:a.reason,wasClean:a.wasClean,willReconnect:i._willReconnect(),wasRequested:b};i.onDisconnect(c.willReconnect,c),i._reconnect()},l=function(a){if(c){var b=c;return c=null,b(a)}return i.onError(a)},m=a.timeout?setTimeout(function timeoutHandler(){if(i._cleanup(),l(new f('Connection timed out',e.TIMEOUT)),b)return i._reconnect()},a.timeout):null;j.onopen=function(){clearTimeout(m),j.onopen=null,i._hello(a.auth).then(function(){i.onConnect(),l()}).catch(function(a){a.path&&delete i._subscriptions[a.path],i._disconnect(function(){return d(l)(a)},!0)})},j.onerror=function(a){if(clearTimeout(m),i._willReconnect())return k(a);i._cleanup();var b=new f('Socket error',e.WS);return l(b)},j.onclose=k,j.onmessage=function(a){return i._onMessage(a)}},h.prototype.overrideReconnectionAuth=function(a){return!!this._reconnection&&(this._reconnection.settings.auth=a,!0)},h.prototype.reauthenticate=function(a){this.overrideReconnectionAuth(a);return this._send({type:'reauth',auth:a},!0)},h.prototype.disconnect=function(){var a=this;return new Promise(function(b){return a._disconnect(b,!1)})},h.prototype._disconnect=function(a,c){this._reconnection=null,clearTimeout(this._reconnectionTimer),this._reconnectionTimer=null;var d=this._disconnectRequested||!c;return this._disconnectListeners?(this._disconnectRequested=d,void this._disconnectListeners.push(a)):this._ws&&(this._ws.readyState===b||this._ws.readyState===0)?void(this._disconnectRequested=d,this._disconnectListeners=[a],this._ws.close()):a()},h.prototype._cleanup=function(){if(this._ws){var j=this._ws;this._ws=null,j.readyState!==3&&j.readyState!==2&&j.close(),j.onopen=null,j.onclose=null,j.onerror=a,j.onmessage=null}this._packets=[],this.id=null,clearTimeout(this._heartbeat),this._heartbeat=null;var b=new f('Request failed - server disconnected',e.DISCONNECT),c=this._requests;this._requests={};for(var d=Object.keys(c),g=0;g<d.length;++g){var h=d[g],i=c[h];clearTimeout(i.timeout),i.reject(b)}if(this._disconnectListeners){var k=this._disconnectListeners;this._disconnectListeners=null,this._disconnectRequested=!1,k.forEach(function(a){return a()})}},h.prototype._reconnect=function(){var b=this,c=this._reconnection;if(c){if(1>c.retries)return this._disconnect(a,!0);--c.retries,c.wait+=c.delay;var d=Math.min(c.wait,c.maxDelay);this._reconnectionTimer=setTimeout(function(){b._connect(c.settings,!1,function(a){if(a)return b.onError(a),b._reconnect()})},d)}},h.prototype.request=function(a){'string'==typeof a&&(a={method:'GET',path:a});var b={type:'request',method:a.method||'GET',path:a.path,headers:a.headers,payload:a.payload};return this._send(b,!0)},h.prototype.message=function(a){return this._send({type:'message',message:a},!0)},h.prototype._isReady=function(){return this._ws&&this._ws.readyState===b},h.prototype._send=function(a,b){if(!this._isReady())return Promise.reject(new f('Failed to send message - server disconnected',e.DISCONNECT));a.id=++this._ids;try{var d=c(a)}catch(a){return Promise.reject(a)}if(!b)try{return this._ws.send(d),Promise.resolve()}catch(a){return Promise.reject(new f(a,e.WS))}var g={resolve:null,reject:null,timeout:null},h=new Promise(function(a,b){g.resolve=a,g.reject=b});this._settings.timeout&&(g.timeout=setTimeout(function(){return g.timeout=null,g.reject(new f('Request timed out',e.TIMEOUT))},this._settings.timeout)),this._requests[a.id]=g;try{this._ws.send(d)}catch(b){return clearTimeout(this._requests[a.id].timeout),delete this._requests[a.id],Promise.reject(new f(b,e.WS))}return h},h.prototype._hello=function(a){var b={type:'hello',version:'2'};a&&(b.auth=a);var c=this.subscriptions();return c.length&&(b.subs=c),this._send(b,!0)},h.prototype.subscriptions=function(){return Object.keys(this._subscriptions)},h.prototype.subscribe=function(a,b){var c=this;if(!a||'/'!==a[0])return Promise.reject(new f('Invalid path',e.USER));var d=this._subscriptions[a];if(d)return-1===d.indexOf(b)&&d.push(b),Promise.resolve();if(this._subscriptions[a]=[b],!this._isReady())return Promise.resolve();var g=this._send({type:'sub',path:a},!0);return g.catch(function(){delete c._subscriptions[a]}),g},h.prototype.unsubscribe=function(b,c){if(!b||'/'!==b[0])return Promise.reject(new f('Invalid path',e.USER));var d=this._subscriptions[b];if(!d)return Promise.resolve();var g=!1;if(!c)delete this._subscriptions[b],g=!0;else{var i=d.indexOf(c);if(-1===i)return Promise.resolve();d.splice(i,1),d.length||(delete this._subscriptions[b],g=!0)}if(!g||!this._isReady())return Promise.resolve();var h=this._send({type:'unsub',path:b},!0);return h.catch(a),h},h.prototype._onMessage=function(b){this._beat();var c=b.data,d=c[0];if('{'!==d){if(this._packets.push(c.slice(1)),'!'!==d)return;c=this._packets.join(''),this._packets=[]}this._packets.length&&(this._packets=[],this.onError(new f('Received an incomplete message',e.PROTOCOL)));try{var g=JSON.parse(c)}catch(a){return this.onError(new f(a,e.PROTOCOL))}var h=null;if(g.statusCode&&400<=g.statusCode&&(h=new f(g.payload.message||g.payload.error||'Error',e.SERVER),h.statusCode=g.statusCode,h.data=g.payload,h.headers=g.headers,h.path=g.path),'ping'===g.type)return this._send({type:'ping'},!1).catch(a);if('update'===g.type)return this.onUpdate(g.message);if('pub'===g.type||'revoke'===g.type){var l=this._subscriptions[g.path];if('revoke'===g.type&&delete this._subscriptions[g.path],l&&void 0!==g.message){var m={};'revoke'===g.type&&(m.revoked=!0);for(var n=0;n<l.length;++n)l[n](g.message,m)}return}var j=this._requests[g.id];if(!j)return this.onError(new f('Received response for unknown request',e.PROTOCOL));clearTimeout(j.timeout),delete this._requests[g.id];var k=function(a,b){return a?j.reject(a):j.resolve(b)};return'request'===g.type?k(h,{payload:g.payload,statusCode:g.statusCode,headers:g.headers}):'message'===g.type?k(h,{payload:g.message}):'hello'===g.type?(this.id=g.socket,g.heartbeat&&(this._heartbeatTimeout=g.heartbeat.interval+g.heartbeat.timeout,this._beat()),k(h)):'reauth'===g.type?k(h,!0):'sub'===g.type||'unsub'===g.type?k(h):(k(new f('Received invalid response',e.PROTOCOL)),this.onError(new f('Received unknown response type: '+g.type,e.PROTOCOL)))},h.prototype._beat=function(){var a=this;this._heartbeatTimeout&&(clearTimeout(this._heartbeat),this._heartbeat=setTimeout(function(){a.onError(new f('Disconnecting due to heartbeat timeout',e.TIMEOUT)),a.onHeartbeatTimeout(a._willReconnect()),a._ws.close()},this._heartbeatTimeout))},h.prototype._willReconnect=function(){return!!(this._reconnection&&1<=this._reconnection.retries)},{Client:h}});
